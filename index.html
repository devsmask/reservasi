<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yacht Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; }
    #calendar { max-width: 100%; margin: 1rem auto; }
    .fc-daygrid-day-number { cursor: pointer; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <div id="loginSection">
    <h3 class="mb-3">Login</h3>
    <input type="text" class="form-control mb-2" id="username" placeholder="Username">
    <input type="password" class="form-control mb-2" id="password" placeholder="Password">
    <button class="btn btn-primary w-100" onclick="login()">Login</button>
  </div>

  <div id="mainSection" class="hidden">
    <h2 class="my-3">Yacht Booking</h2>
    <button class="btn btn-success mb-3" onclick="openModal()">Add Booking</button>
    <table id="bookingTable" class="display w-100"></table>
    <div id="calendar"></div>
    <div id="bookingDetails" class="mt-4"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="bookingForm">
        <div class="modal-header">
          <h5 class="modal-title">Booking Form</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="bookingId">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required>
          <label class="form-label mt-2">Agent</label>
          <input type="text" class="form-control" id="agent" required>
          <label class="form-label mt-2">Boat</label>
          <select class="form-select" id="boat">
            <option>Morgan</option>
            <option>Seaview</option>
            <option>BM 1</option>
            <option>BM 2</option>
            <option>BM 3</option>
            <option>AM 1</option>
            <option>AM 2</option>
            <option>CATAMARAN</option>
          </select>
          <label class="form-label mt-2">Packages</label>
          <select class="form-select" id="packages">
            <option>Full day trip Penida/ Lembongan Island</option>
            <option>Full day trip Gili/ Lombok Island</option>
            <option>Half day trip Nusa Dua Area</option>
          </select>
          <label class="form-label mt-2">Total Pax</label>
          <input type="text" class="form-control" id="totalPax">
          <label class="form-label mt-2">Guest Name</label>
          <textarea class="form-control" id="guestName"></textarea>
          <label class="form-label mt-2">Pickup Time</label>
          <input type="time" class="form-control" id="pickup" value="08:00">
          <label class="form-label mt-2">Note</label>
          <textarea class="form-control" id="note"></textarea>
          <label class="form-label mt-2">Status</label>
          <select class="form-select" id="status">
            <option>Hold</option>
            <option>Confirm</option>
            <option>Cancel</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyGqpZJ-9UPpleL9q8ysMI6t4NRxxartYhCW5aczKjBuX3FjZpdk35oCyez11FfJPInNw/exec';
let bookingData = [];

function login() {
  axios.post(`${API_URL}?action=login`, {
    username: document.getElementById('username').value,
    password: document.getElementById('password').value
  }).then(res => {
    if (res.data.success) {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
      loadData();
    } else alert('Login failed');
  });
}

function loadData() {
  axios.get(API_URL).then(res => {
    bookingData = res.data;
    const table = $('#bookingTable').DataTable({
      data: bookingData,
      destroy: true,
      columns: [
        { title: '#', data: null, render: (d,t,r,m) => m.row + 1 },
        { title: 'ID', data: 'ID' },
        { title: 'Date', data: 'Date' },
        { title: 'Boat', data: 'Boat' },
        { title: 'Agent', data: 'Agent' },
        { title: 'Packages', data: 'Packages' },
        { title: 'Guest', data: 'GuestName' },
        { title: 'Status', data: 'Status' },
        { title: 'Action', data: null, render: d => `<button class='btn btn-sm btn-warning' onclick='editBooking("${d.ID}")'>Edit</button>` }
      ]
    });
    renderCalendar();
  });
}

function openModal() {
  document.getElementById('bookingForm').reset();
  document.getElementById('bookingId').value = '';
  new bootstrap.Modal(document.getElementById('bookingModal')).show();
}

function editBooking(id) {
  const data = bookingData.find(d => d.ID === id);
  if (!data) return;
  document.getElementById('bookingId').value = data.ID;
  document.getElementById('date').value = data.Date;
  document.getElementById('agent').value = data.Agent;
  document.getElementById('boat').value = data.Boat;
  document.getElementById('packages').value = data.Packages;
  document.getElementById('totalPax').value = data.TotalPax;
  document.getElementById('guestName').value = data.GuestName;
  document.getElementById('pickup').value = data.Pickup;
  document.getElementById('note').value = data.Note;
  document.getElementById('status').value = data.Status;
  new bootstrap.Modal(document.getElementById('bookingModal')).show();
}

document.getElementById('bookingForm').onsubmit = e => {
  e.preventDefault();
  const payload = {
    ID: document.getElementById('bookingId').value,
    Date: document.getElementById('date').value,
    Agent: document.getElementById('agent').value,
    Boat: document.getElementById('boat').value,
    Packages: document.getElementById('packages').value,
    TotalPax: document.getElementById('totalPax').value,
    GuestName: document.getElementById('guestName').value,
    Pickup: document.getElementById('pickup').value,
    Note: document.getElementById('note').value,
    Status: document.getElementById('status').value
  };
  const action = payload.ID ? 'edit' : 'add';
  axios.post(`${API_URL}?action=${action}`, payload).then(res => {
    if (res.data.success) {
      bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
      loadData();
    } else alert('Failed to save');
  });
};

function renderCalendar() {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    dateClick: function(info) {
      const selected = bookingData.filter(b => b.Date === info.dateStr);
      if (selected.length) {
        let text = selected.map(b => `${b.Boat} - ${b.GuestName} (${b.Status})`).join('\n');
        document.getElementById('bookingDetails').innerHTML = `
          <h5>Booking on ${info.dateStr}</h5>
          <textarea class='form-control' rows='5'>${text}</textarea>
          <a class='btn btn-success mt-2' target='_blank' href='https://wa.me/?text=${encodeURIComponent(text)}'>Forward to WhatsApp</a>
        `;
      } else {
        document.getElementById('bookingDetails').innerHTML = '<p>No booking on selected date.</p>';
      }
    },
    events: Object.values(
      bookingData.reduce((acc, b) => {
        if (!acc[b.Date]) acc[b.Date] = { title: b.Boat, start: b.Date };
        else acc[b.Date].title += `, ${b.Boat}`;
        return acc;
      }, {})
    )
  });
  calendar.render();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
