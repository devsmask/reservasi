<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Yacht Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <style>
    body { font-size: 0.95rem; padding: 1rem; }
    .fc-toolbar-title { font-size: 1.2rem; }
    #calendar { max-width: 100%; margin: 20px auto; }
  </style>
</head>
<body>
<div id="loginSection" class="text-center">
  <h4>Masukkan Passcode</h4>
  <input type="password" id="passcodeInput" class="form-control w-25 d-inline" placeholder="Passcode">
  <button onclick="checkPasscode()" class="btn btn-primary">Masuk</button>
</div>

<div id="mainApp" style="display:none;">
  <h3>Data Booking</h3>
  <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#formModal" onclick="resetForm()">Tambah Booking</button>
  <table id="bookingTable" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>#</th><th>ID</th><th>Date</th><th>Agent</th><th>Boat</th><th>Packages</th><th>TotalPax</th><th>GuestName</th><th>Pickup</th><th>Note</th><th>Status</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="calendar"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Form Booking</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="bookingForm">
        <input type="hidden" id="ID">
        <div class="mb-2"><label>Tanggal</label><input type="date" id="Date" class="form-control" required></div>
        <div class="mb-2"><label>Pickup</label><input type="time" id="Pickup" class="form-control" required></div>
        <div class="mb-2"><label>Agent</label><input type="text" id="Agent" class="form-control" required></div>
        <div class="mb-2"><label>Boat</label><input type="text" id="Boat" class="form-control" required></div>
        <div class="mb-2"><label>Packages</label><input type="text" id="Packages" class="form-control"></div>
        <div class="mb-2"><label>Total Pax</label><input type="number" id="TotalPax" class="form-control"></div>
        <div class="mb-2"><label>Guest Name</label><textarea id="GuestName" class="form-control"></textarea></div>
        <div class="mb-2"><label>Note</label><textarea id="Note" class="form-control"></textarea></div>
        <div class="mb-2"><label>Status</label>
          <select id="Status" class="form-control">
            <option>Hold</option><option>Confirm</option><option>Cancel</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </form>
    </div>
  </div></div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyutfKfRRcgkLCFIDgnGIdHObbfz5HvCTSQmvs1bkS4xB1Tc28d5RV7gfCwSrSg1Qbs-g/exec';

async function checkPasscode() {
  const pass = document.getElementById('passcodeInput').value;
  const res = await fetch(`${scriptURL}?action=check&passcode=${pass}`);
  const json = await res.json();
  if (json.success) {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    loadData();
  } else {
    alert('Passcode salah!');
  }
}

function loadData() {
  fetch(`${scriptURL}?action=get`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector('#bookingTable tbody');
      tbody.innerHTML = '';
      data.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${item.ID}</td><td>${item.Date}</td><td>${item.Agent}</td>
          <td>${item.Boat}</td><td>${item.Packages}</td><td>${item.TotalPax}</td>
          <td>${item.GuestName}</td><td>${item.PickUp}</td><td>${item.Note}</td>
          <td>${item.Status}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick='editBooking(${JSON.stringify(item)})'>Edit</button>
          </td>`;
        tbody.appendChild(tr);
      });
      if ($.fn.DataTable.isDataTable('#bookingTable')) {
        $('#bookingTable').DataTable().clear().destroy();
      }
      $('#bookingTable').DataTable();
      renderCalendar(data);
    });
}

document.getElementById('bookingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  data.action = data.ID ? 'update' : 'add';
  const res = await fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(data)
  });
  const result = await res.json();
  if (result.success) {
    bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
    loadData();
  }
});

function editBooking(item) {
  for (let key in item) {
    const el = document.getElementById(key);
    if (el) el.value = item[key];
  }
  new bootstrap.Modal(document.getElementById('formModal')).show();
}

function resetForm() {
  document.getElementById('bookingForm').reset();
  document.getElementById('ID').value = '';
}

function renderCalendar(data) {
  const calendarEl = document.getElementById('calendar');
  calendarEl.innerHTML = '';
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: data.map(item => ({
      title: `${item.Boat} (${item.GuestName})`,
      start: item.Date,
      extendedProps: item,
    })),
    eventClick: function(info) {
      const d = info.event.extendedProps;
      const detail = `
ğŸš¤ *Yacht Booking* ğŸš¤
ğŸ“… Tanggal: ${d.Date}
â° Pickup: ${d.PickUp}
ğŸ‘¤ Agent: ${d.Agent}
ğŸ›¥ï¸ Boat: ${d.Boat}
ğŸ“¦ Packages: ${d.Packages}
ğŸ‘¥ Pax: ${d.TotalPax}
ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Guest: ${d.GuestName}
ğŸ“ Note: ${d.Note}
ğŸ“Œ Status: ${d.Status}
`;
      const url = `https://wa.me/?text=${encodeURIComponent(detail)}`;
      window.open(url, '_blank');
    }
  });
  calendar.render();
}
</script>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
</body>
</html>
